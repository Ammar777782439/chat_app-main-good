# توثيق واجهة برمجة التطبيقات (API Documentation)

## نظرة عامة

هذا المستند يوثق واجهة برمجة التطبيقات (API) الخاصة بتطبيق الدردشة. يوفر التطبيق واجهة RESTful API للتفاعل مع نظام الدردشة، بما في ذلك إدارة المستخدمين والرسائل.

## قاعدة URL

```
http://127.0.0.1:8000/
```

## المصادقة

يدعم التطبيق ثلاث طرق للمصادقة:

### 1. مصادقة JWT (الموصى بها)

JWT (JSON Web Tokens) هي الطريقة المفضلة للمصادقة، خاصة عند استخدام Google OAuth.

#### الحصول على توكن JWT

```
GET /api/auth/jwt/
```

**الاستجابة**:
```json
{
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**ملاحظة**: يجب أن تكون مسجل الدخول بالفعل للوصول إلى هذه النقطة.

#### استخدام توكن JWT

أضف رأس `Authorization` إلى جميع الطلبات:

```
Authorization: Bearer your_access_token_here
```

#### مميزات JWT:
- أكثر أمانًا من Token Authentication لأنه لا يحفظ التوكن في قاعدة البيانات
- يمكن تجديد التوكن عند انتهاء صلاحيته باستخدام refresh_token
- متوافق تمامًا مع Google OAuth
- يحتوي على معلومات المستخدم مشفرة داخل التوكن

### 2. مصادقة التوكن (Token Authentication)

#### الحصول على توكن المصادقة

```
GET /api/token/
```

**الاستجابة**:
```json
{
    "token": "9944b09199c62bcf9418ad846dd0e4bbdfc6ee4b"
}
```

**ملاحظة**: يجب أن تكون مسجل الدخول بالفعل للوصول إلى هذه النقطة.

#### استخدام التوكن

أضف رأس `Authorization` إلى جميع الطلبات:

```
Authorization: Token your_token_here
```

### 3. مصادقة الجلسة (Session Authentication)

يمكن استخدام مصادقة الجلسة عند التفاعل مع API من خلال متصفح الويب.

1. قم بتسجيل الدخول إلى التطبيق من خلال واجهة المستخدم
2. استخدم ملفات تعريف الارتباط (cookies) التي تم إنشاؤها للمصادقة
3. تأكد من إرسال ملفات تعريف الارتباط مع كل طلب API

### 4. مصادقة Google OAuth

```
GET /social-auth/login/google-oauth2/
```

بعد المصادقة الناجحة، سيتم إعادة توجيه المستخدم إلى الصفحة الرئيسية للتطبيق.

## نقاط نهاية الرسائل

### الحصول على الرسائل

```
GET /api/messages/
```

**معلمات الاستعلام**:
- `user`: (اختياري) تصفية الرسائل حسب اسم المستخدم
- `page`: (اختياري) رقم الصفحة (افتراضي: 1)
- `page_size`: (اختياري) عدد الرسائل في الصفحة (افتراضي: 10، الحد الأقصى: 100)

**الاستجابة**:
```json
{
    "count": 100,
    "next": "http://127.0.0.1:8000/api/messages/?page=2",
    "previous": null,
    "results": [
        {
            "id": 1,
            "sender": 1,
            "receiver": 2,
            "content": "مرحبا، كيف حالك؟",
            "timestamp": "2023-06-01T12:00:00Z"
        },
        ...
    ]
}
```

### الحصول على رسالة محددة

```
GET /api/messages/{id}/
```

**الاستجابة**:
```json
{
    "id": 1,
    "sender": 1,
    "receiver": 2,
    "content": "مرحبا، كيف حالك؟",
    "timestamp": "2023-06-01T12:00:00Z"
}
```

### إرسال رسالة جديدة

```
POST /api/messages/
```

**البيانات المطلوبة**:
```json
{
    "receiver": 2,
    "content": "محتوى الرسالة"
}
```

**الاستجابة**:
```json
{
    "id": 101,
    "sender": 1,
    "receiver": 2,
    "content": "محتوى الرسالة",
    "timestamp": "2023-06-02T15:30:00Z"
}
```

### تحديث رسالة

```
POST /api/messages/{id}/update_message/
```

**البيانات المطلوبة**:
```json
{
    "content": "محتوى الرسالة الجديد"
}
```

**الاستجابة**:
```json
{
    "id": 101,
    "sender": 1,
    "receiver": 2,
    "content": "محتوى الرسالة الجديد",
    "timestamp": "2023-06-02T15:30:00Z"
}
```

**ملاحظة**: يمكنك فقط تحديث الرسائل التي أرسلتها.

### حذف رسالة

```
DELETE /api/messages/{id}/delete_message/
```

**الاستجابة**: رمز الحالة 204 (No Content) في حالة النجاح.

**ملاحظة**: يمكنك فقط حذف الرسائل التي أرسلتها.

## نموذج البيانات

### Message (الرسالة)

| الحقل | النوع | الوصف |
|-------|------|-------|
| id | Integer | المعرف الفريد للرسالة |
| sender | Integer | معرف المستخدم المرسل |
| receiver | Integer | معرف المستخدم المستقبل |
| content | String | محتوى الرسالة |
| timestamp | DateTime | وقت إرسال الرسالة |
| deleted_at | DateTime | وقت حذف الرسالة (null إذا لم تحذف) |

## WebSockets

يدعم التطبيق WebSockets للتواصل في الوقت الحقيقي.

### نقطة اتصال WebSocket

```
ws://127.0.0.1:8000/ws/chat/{room_name}/
```

حيث `{room_name}` هو اسم المستخدم الآخر في المحادثة.

### إرسال رسالة عبر WebSocket

```json
{
    "message": "محتوى الرسالة",
    "username": "اسم_المستخدم",
    "room_name": "اسم_الغرفة"
}
```

### تحديث رسالة عبر WebSocket

```json
{
    "message": "محتوى الرسالة الجديد",
    "username": "اسم_المستخدم",
    "room_name": "اسم_الغرفة",
    "message_id": 101
}
```

### حذف رسالة عبر WebSocket

```json
{
    "username": "اسم_المستخدم",
    "room_name": "اسم_الغرفة",
    "deleted_message_id": 101
}
```

## أكواد الحالة

| الكود | الوصف |
|-------|-------|
| 200 | نجاح |
| 201 | تم إنشاء الكائن بنجاح |
| 204 | تم تنفيذ الطلب بنجاح ولا توجد بيانات للإرجاع |
| 400 | طلب غير صالح |
| 401 | غير مصرح |
| 403 | ممنوع |
| 404 | غير موجود |
| 500 | خطأ في الخادم |

## ملاحظات هامة

1. يجب أن تكون مصادقًا لاستخدام أي من نقاط النهاية المذكورة أعلاه.
2. يمكنك فقط تحديث أو حذف الرسائل التي أرسلتها.
3. عند استخدام مصادقة الجلسة، تأكد من إرسال رمز CSRF مع طلبات POST/PUT/DELETE.
4. يتم ترتيب الرسائل حسب الأحدث أولاً في استجابات API.
5. يمكن استخدام WebSockets للحصول على تحديثات في الوقت الحقيقي.
